<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Pygmentsを使ってJekyll内記事のコードハイライトを実現する - kk_Atakaの日記</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/css/github-markdown.css">
    <link rel="stylesheet" href="/static/css/highlight.css">
    <style>
      .markdown-body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
      }
    </style>
    <link rel="icon" href="/static/favicon.ico">
  </head>
  <body>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34929069-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <a href="/">kk_Atakaの日記</a>
    <a href="/archives.html">Archive</a>
    <a href="/tags.html">Tag</a>
    <a href="/pages.html">Page</a>

    <article class="markdown-body">
      <h1>Pygmentsを使ってJekyll内記事のコードハイライトを実現する</h1>
      <div class="published">
       
          <span>Tags: </span>
          
            <i>[ <a href="/tags.html#Python" class="tag">Python</a> ]</i>
          
            <i>[ <a href="/tags.html#Ruby" class="tag">Ruby</a> ]</i>
          
            <i>[ <a href="/tags.html#Jekyll" class="tag">Jekyll</a> ]</i>
          
        
        
          <span>Published: 2012/09/21</span>
        
      </div>



<div class="pagination">
  <ul>
    
      <li class="prev">
        <a href="/2012/09/20/jekyll" title="JekyllをGitHub Pagesに上げるための準備">
          JekyllをGitHub Pagesに上げるための準備
        </a>
      </li>
    
    <li>
      <a href="/archives.html">Archive</a>
    </li>
    
      <li class="next">
        <a href="/2012/10/01/bundle-exec-bat" title="bundle execを省略したいのでバッチを作った(Windows版)">
          bundle execを省略したいのでバッチを作った(Windows版)
        </a>
      </li>
    
  </ul>
</div>


<h2 class="content_tree">目次</h2><div class="content_tree_list"><ul><!-- start tree list --><li><a href='#あらすじ'>あらすじ</a></li><li><a href='#環境'>環境</a></li><li><a href='#参考サイト'>参考サイト</a></li><li><a href='#手順'>手順</a></li><li><a href='#jekyllの修正'>Jekyllの修正</a></li><li><a href='#色づけ'>色づけ</a></li></ul></ul><!-- end of tree list --></div>

<h2 id="あらすじ">あらすじ</h2>

<p>Jekyllではデフォルトでコードにハイライトをつける事はできないようなので、Pygmentsという拡張を入れる。</p>

<h2 id="環境">環境</h2>

<ul>
<li>Python 2.7.3 (2.6以上が必要)

<ul>
<li>easy_install</li>
</ul></li>
</ul>

<p>easy<em>installは<a href="http://peak.telecommunity.com/dist/ez_setup.py">http://peak.telecommunity.com/dist/ez_setup.py</a>からDLし `$ (sudo) python ez</em>setup.py` でインストールする。</p>

<p>※ 後に以下のようなエラーが出るかもしれない。</p>

<blockquote>
<p>Liquid error: undefined method &#39;Py_IsInitialized&#39; for RubyPython::Python:Module</p>
</blockquote>

<p>これはRubyからPythonを呼びに行くRubypythonというライブラリの中で、libpython2.7.soというファイルを探しに行くが、見つからないとすぐあきらめるようなので？　<code>--enable-shared</code> オプションつけてのインストールが吉。</p>

<p>また、以下の様なエラーが出た場合、libpython2.7.so.1.0が見つからなくてpythonコマンドが実行できなくなった。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ python
&gt; python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory

$ ldd python
    linux-vdso.so.1 =&gt;  (0x00007fff9cf94000)
    libpython2.7.so.1.0 =&gt; not found
    libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x000000343d600000)
    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x000000343ce00000)
    libutil.so.1 =&gt; /lib64/libutil.so.1 (0x0000003440200000)
    libm.so.6 =&gt; /lib64/libm.so.6 (0x0000003665600000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x000000343d200000)
    /lib64/ld-linux-x86-64.so.2 (0x000000343ca00000)
</code></pre></div>
<p>/usr/libとか共有ライブラリが検索するように設定しているパスにシンボリックリンクを貼るか、LD<em>LIBRARY</em>PATHにパスを追加するか/etc/ld.so.conf.d/hogehoge.confを作ってパスを追加するかldconfigコマンドでパスを追加してからもう一回Pythonインストールする。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/shrkw/20110124/1295851744">CentOS 5.5にvirtualenvを入れて、Python2.7とFlaskの環境を作ったよ！ - Bouldering &amp; Com.</a></li>
<li><a href="http://d.hatena.ne.jp/natsumesouxx/20111126/1322339821">共有ライブラリのコンパイル時に必要な検索パスを追加する方法 - ドキ！丸ごと！夏目だらけの水泳大会</a></li>
</ul>

<h2 id="参考サイト">参考サイト</h2>

<ul>
<li><a href="http://fingaholic.tumblr.com/post/20841800395/windows-pygments"> Windowsでpygmentsを使ってコードハイライト </a></li>
<li><a href="http://d.hatena.ne.jp/hokaccha/20120808/1344436656">pygmentsが原因でjekyllが重くなってた</a></li>
<li><a href="https://github.com/tombell/jekyll/commit/b2a1d61c0407d6612450fe7d90a9a1a397aaa28e">Swap out albino for pygments.rb</a></li>
<li><a href="https://github.com/mojombo/tpw/blob/master/css/syntax.css">tpw / css / syntax.css</a></li>
</ul>

<h2 id="手順">手順</h2>

<p>いきなりeasy_install。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ easy_install Pygments
Searching for Pygments
Best match: pygments 1.5
Processing pygments-1.5-py2.7.egg
pygments 1.5 is already the active version in easy-install.pth
Installing pygmentize-script.py script to C:\Pythons\Python27\Scripts
Installing pygmentize.exe script to C:\Pythons\Python27\Scripts
Installing pygmentize.exe.manifest script to C:\Pythons\Python27\Scripts

Using c:\pythons\python27\lib\site-packages\pygments-1.5-py2.7.egg
Processing dependencies for Pygments
Finished processing dependencies for Pygments
</code></pre></div>
<p>highlight hogeタグをテストするが、以下のようなエラーが表示されてしまった。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Liquid error: Bad file descriptor
</code></pre></div>
<p><a href="http://fingaholic.tumblr.com/post/20841800395/windows-pygments" title=" Windowsでpygmentsを使ってコードハイライト "> Windowsでpygmentsを使ってコードハイライト </a>によると、</p>

<blockquote>
<p>C:\Ruby193\lib\ruby\gems\1.9.1\gems\albino-1.3.3\lib\albino.rbにパッチを当てる。</p>
</blockquote>

<p>という事で <code>albino.rb</code> にパッチをあてると解決するらしい。</p>

<p>確かに、Bundlerでインストールしたgemの中にしっかりと <code>albino-1.3.3</code> がある。</p>

<p>……が。このalbinoはhighlightがあるたびにPygmentsを呼ぶようなのでこのまま使っていくと超重くなるらしい。</p>

<blockquote>
<p>今現在gemでインストールできるjekyllはコードハイライトにalbinoっていう
モジュールを使ってみるみたいで、こいつはハイライトするコードブロックが
あるあるたびにpygamentsプロセスを立ち上げるらしく、それが原因で超重くなってたみたい。</p>
</blockquote>

<p>それはできれば避けたい……。</p>

<h2 id="jekyllの修正">Jekyllの修正</h2>

<p><a href="https://github.com/tombell/jekyll/commit/b2a1d61c0407d6612450fe7d90a9a1a397aaa28e">Swap out albino for pygments.rb</a>を見ながら <code>albino</code> を <code>pygments.rb</code> に差し替えてやる。</p>

<p>差し替えが完了したらpygments.rbとその依存gemを取りに行くためbundle update。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ bundle update
Fetching source index for http://rubygems.org/
Fetching source index for http://rubygems.org/
Using RedCloth (4.2.9)
Installing blankslate (3.1.2)
Using fast-stemmer (1.0.1)
Using classifier (1.3.3)
Using directory_watcher (1.4.1)
Installing ffi (1.0.11) with native extensions
Installing kramdown (0.14.0)
Using liquid (2.4.1)
Using syntax (1.0.0)
Installing maruku (0.6.1)
Installing rubypython (0.5.3)
Installing pygments.rb (0.2.13)
Using jekyll (0.11.2)
Using bundler (1.0.21)
Your bundle is updated! Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre></div>
<p>これでまずは</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"> {% highlight ruby  %}
 puts &quot;hello world&quot;
 {% endhighlight  %}
</code></pre></div>
<p>こういう表記が一応、liquid errorがでずに出力されるようになった。</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">puts</span> <span class="s2">&quot;hello world&quot;</span>
<span class="n">world</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">w</span><span class="o">|</span>
  <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;hoge&quot;</span>
<span class="k">end</span></code></pre></div>

<h2 id="色づけ">色づけ</h2>

<p>最後にハイライト。(記事上はもう色がついちゃってるんだけど、本来は全部黒いはず)これは<a href="https://github.com/mojombo/tpw/blob/master/css/syntax.css">tpw / css / syntax.css</a>からCSSを持ってくれば良い。このsyntax.cssの内容を <code>JEKYLL_HOME\assets\themes\twitter\bootstrap\css\bootstrap.min.css</code> に追記する。</p>

<p>これでOK！</p>


<div class="pagination">
  <ul>
    
      <li class="prev">
        <a href="/2012/09/20/jekyll" title="JekyllをGitHub Pagesに上げるための準備">
          JekyllをGitHub Pagesに上げるための準備
        </a>
      </li>
    
    <li>
      <a href="/archives.html">Archive</a>
    </li>
    
      <li class="next">
        <a href="/2012/10/01/bundle-exec-bat" title="bundle execを省略したいのでバッチを作った(Windows版)">
          bundle execを省略したいのでバッチを作った(Windows版)
        </a>
      </li>
    
  </ul>
</div>


<div class="social-module">
    <br>
  <!-- Tweet Button -->
  <a href="https://twitter.com/share"
     data-url="http://gosyujin.github.io/2012/09/21/jekyll-pygments" data-text="kk_Atakaの日記 - Pygmentsを使ってJekyll内記事のコードハイライトを実現する" data-related="kk_Ataka"
     data-lang="ja" data-size="horizontal" data-dnt="true" class="twitter-share-button">Tweet</a>
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8" async="async"></script>

  <!-- Hatena Bookmark Users -->
  <a href="http://b.hatena.ne.jp/entry/http://gosyujin.github.io/2012/09/21/jekyll-pygments/">
    <img src="http://b.hatena.ne.jp/entry/image/http://gosyujin.github.io/2012/09/21/jekyll-pygments/" />
    </a>
  <!-- Hatena Bookmark Button -->
  <a href="http://b.hatena.ne.jp/entry/http://gosyujin.github.io/2012/09/21/jekyll-pygments/"
     data-hatena-bookmark-title="kk_Atakaの日記 - Pygmentsを使ってJekyll内記事のコードハイライトを実現する"
     data-hatena-bookmark-layout="standard" class="hatena-bookmark-button" title="add Hatena bookmark">
    <img src="http://b.st-hatena.com/images/entry-button/button-only.gif"
	 alt="add Hatena bookmark" width="20" height="20" style="border: none;" />
    </a>
  <script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

  <!-- Hatena Bookmark comment http://blog.masuidrive.jp/2008/04/17/released-hatena-bookmark-anywhere/ -->
  <script type= "text/javascript">/*<![CDATA[*/
// var hatena_bookmark_anywhere_limit = 10; // 表示する件数
// var hatena_bookmark_anywhere_style = true; // trueでデフォルトスタイル falseを設定するとCSSでスタイルの指定が可能
// var hatena_bookmark_anywhere_collapse = false; // trueにすると、コメントの書いてないブクマを表示しない。指定しない場合は、表示件数を超えた場合のみコメントを表示しない
// var hatena_bookmark_anywhere_url = http://gosyujin.github.io/2012/09/21/jekyll-pygments/; // 表示するURL 未指定の場合、現在のページ
/*]]>*/</script>
  <script src="https://raw.github.com/masuidrive/hatena-bookmark-anywhere/master/hatena-bookmark-anywhere-0-1.js" type="text/javascript" charset="utf-8"></script>
  <div id="hatena_bookmark_anywhere"></div>
</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'kkataka'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


    </article>
    <hr />
    <address>Author: kk_Ataka / Powered by Jekyll on GitHub Pages</address>
  <body>
</html>

