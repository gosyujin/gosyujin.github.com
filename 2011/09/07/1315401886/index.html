<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Redmineのプラグイン作成のための備忘録と、時々SQLite3 - kk_Atakaの日記</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/css/github-markdown.css">
    <link rel="stylesheet" href="/static/css/highlight.css">
    <style>
      .markdown-body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
      }
    </style>
    <link rel="icon" href="/static/favicon.ico">
  </head>
  <body>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34929069-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <a href="/">kk_Atakaの日記</a>
    <a href="/archives.html">Archive</a>
    <a href="/tags.html">Tag</a>
    <a href="/pages.html">Page</a>

    <article class="markdown-body">
      <h1>Redmineのプラグイン作成のための備忘録と、時々SQLite3</h1>
      <div class="published">
       
          <span>Tags: </span>
          
            <i>[ <a href="/tags.html#Ruby" class="tag">Ruby</a> ]</i>
          
            <i>[ <a href="/tags.html#Redmine" class="tag">Redmine</a> ]</i>
          
            <i>[ <a href="/tags.html#SQLite3" class="tag">SQLite3</a> ]</i>
          
            <i>[ <a href="/tags.html#Windows" class="tag">Windows</a> ]</i>
          
            <i>[ <a href="/tags.html#備忘録" class="tag">備忘録</a> ]</i>
          
        
        
          <span>Published: 2011/09/07</span>
        
      </div>



<div class="pagination">
  <ul>
    
      <li class="prev">
        <a href="/2011/09/04/1315146050" title="vmstatとかiostatとかsarとかswapコマンドのメモ">
          vmstatとかiostatとかsarとかswapコマンドのメモ
        </a>
      </li>
    
    <li>
      <a href="/archives.html">Archive</a>
    </li>
    
      <li class="next">
        <a href="/2011/09/12/1315826713" title="Solarisのパッケージを作ってみる">
          Solarisのパッケージを作ってみる
        </a>
      </li>
    
  </ul>
</div>




<h1>あらすじ</h1>
<dl><dt>今あると幸せになれるもの</dt><dd>チケットのCSVエクスポート機能。ただし、履歴つきで。これがあるといわゆるバグとかPJ課題の管理がRedmineで一元化できExcelの呪縛から解き放てられる……</dd></dl>
<p>既に履歴つきCSVエクスポートプラグインは存在しているようです。<a href="http://d.hatena.ne.jp/suer/20101003/1286120294">履歴付チケット一覧出力プラグインを書いてみた - すえひろがりっっっっ!</a>　ただ、履歴の出方が1履歴毎に列を更新なんですよね。。</p>
<pre class="">No, ... ,履歴
1, ... ,#1の履歴,#2の履歴,#3の履歴
2, ... ,#1の履歴,#2の履歴</pre>
<p>今自分が抱えている縛り的にはこう出てほしい。</p>
<pre class="">No, ... ,履歴
1, ... ,&quot;#1の履歴
#2の履歴,
#3の履歴&quot;
2, ... ,&quot;#1の履歴,
#2の履歴&quot;</pre>
<p>吐き出したときにチケット1つの履歴を1セルの中に収めたい。CSVに改行はどうなんだとか1セルに改行しまくるのはどうなんだとか色々ありますがそこは縛りなので。。。</p>
<p>だもんで、これを機会にRedmineのプラグインはどう作るのかを調べてみました。</p>
<h1>参考サイト</h1>
<ul><li><a href="http://www.r-labs.org/projects/r-labs/wiki/%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89">r-labs</a></li><li><a href="http://gihyo.jp/dev/serial/01/ruby/0038">Ruby Freaks Lounge：第38回　Redmineプラグイン開発（3）｜gihyo.jp … 技術評論社</a></li></ul>
<h1>環境</h1>
<ul><li>WindowsXP</li><li>Redmine 1.0.0<span class="footnote"><a href="#f1" title="[http://redmine.jp/guide/RedmineInstall/:title=Redmineのインストール | Redmine.JP]　に準拠。" name="fn1">*1</a></span><ul><li>Ruby 1.8.7</li><li>Rails 2.3.5</li><li>Rack 1.0.1</li></ul></li><li>SQLite3 バージョン失念</li></ul>
<h1>プラグインのスケルトン作成</h1>
<p>まずはプラグインのスケルトンというものを作成する。テンプレートみたいなもの？　以下のコマンドで自動生成してくれます。<span class="footnote"><a href="#f2" title="途中でコマンドプロンプトからConsole2というフリーソフトに切り替えたのでパスの区切りが\だったり/だったりしてます。" name="fn2">*2</a></span></p>
<pre class="">&gt;ruby script\generate redmine_plugin extendCsv</pre>
<p>するといきなりエラー。</p>
<pre class="">!!! The bundled mysql.rb driver has been removed from Rails 2.2. Please install
the mysql gem and try again: gem install mysql.</pre>
<p>さらに、</p>
<pre class="">LIBMYSQL.dll が見つからなかったため、このアプリケーションを開始できませんでした。…</pre>
<p>libmysqlが必要らしい。なんでmysqlなんだろう？　SQLite3使うようにしてなかったっけ？</p>
<p>(略)</p>
<p>あーわかった。config/database.ymlがこうなっていた。</p>
<pre class="">production:
  adapter: sqlite3
  database: db/redmine
 
development:
  adapter: mysql
  database: redmine_development
  host: localhost
  username: root
  password:
  encoding: utf8</pre>
<p>productionは変えていたけどdevelopmentはデフォルト=MySQLのままだった。開発時はdevelopmentモードを使うようになっているからmysql探し出したのか。変えてみた。</p>
<pre class="">production:
  adapter: sqlite3
  database: db/redmine
 
development:
  adapter: sqlite3
  database: db/redminedev</pre>
<p>再度。</p>
<pre class="">&gt;ruby script\generate redmine_plugin extendCsv</pre>
<pre class="">C:\redmine-1.0.0&gt;ruby script\generate redmine_plugin extendCsv
      create  vendor/plugins/redmine_extend_csv/app/controllers
      create  vendor/plugins/redmine_extend_csv/app/helpers
      create  vendor/plugins/redmine_extend_csv/app/models
      create  vendor/plugins/redmine_extend_csv/app/views
      create  vendor/plugins/redmine_extend_csv/db/migrate
      create  vendor/plugins/redmine_extend_csv/lib/tasks
      create  vendor/plugins/redmine_extend_csv/assets/images
      create  vendor/plugins/redmine_extend_csv/assets/javascripts
      create  vendor/plugins/redmine_extend_csv/assets/stylesheets
      create  vendor/plugins/redmine_extend_csv/lang
      create  vendor/plugins/redmine_extend_csv/config/locales
      create  vendor/plugins/redmine_extend_csv/test
      create  vendor/plugins/redmine_extend_csv/README.rdoc
      create  vendor/plugins/redmine_extend_csv/init.rb
      create  vendor/plugins/redmine_extend_csv/lang/en.yml
      create  vendor/plugins/redmine_extend_csv/config/locales/en.yml
      create  vendor/plugins/redmine_extend_csv/test/test_helper.rb</pre>
<p>vendor/plugins下にスケルトンができた。この「vendor/plugins/今回作成したディレクトリ」というのがプラグインのルートになるようです。</p>
<pre class="">C:\redmine-1.0.0\vendor\plugins&gt;dir

2011/09/06  09:24    &lt;DIR&gt;          .
2011/09/06  09:24    &lt;DIR&gt;          ..
略
2011/09/06  09:24    &lt;DIR&gt;          redmine_extend_csv
略</pre>
<p>プラス、自動で頭に「redmine」付加+スネークケースにリネームしてくれている。これが規約か…？　とりあえずフォルダ構成等は置いておいて、次の章へ。</p>
<h1>init.rbの作成</h1>
<p>プラグイン名、作者名などを記述できるが今は特になにも設定せず。後でプラグインを表示さす時に戻って来ます。</p>
<p>ここで一回起動してみる。</p>
<pre class="">&gt;ruby script\server</pre>
<p>オプションに-e productionをつけないとdevelopmentモードで起動する。その前に、DBの初期化をしていない場合は初期化を……。(RAILS_ENV=productionを除外)</p>
<pre class="">&gt;rake db:migrate
&gt;rake redmine:load_default_data</pre>
<p>そしてRedmine起動 -> 管理 -> プラグインを見に行くと…あった！(写真なし)</p>
<h1>補足:SQLite3あれこれ</h1>
<p>ちょっとSQLite3も使ってみる。コンソールから見ることもないだろうとexeはDLしていなかったので今回初。</p>
<ul><li>まずexe版SQLite3をDL</li><li>実行</li></ul>
<pre class=""># Redmineのconfig/database.ymlで定義し作成したDBへ接続
&gt;sqlite3.exe REDMINE_DB_FILE
SQLite version 3.7.7.1 2011-06-28 17:39:05
Enter &quot;.help&quot; for instructions
Enter SQL statements terminated with a &quot;;&quot;</pre>
<p>今回はとりあえず下記の2つのコマンドを覚えて帰る。</p>
<table><tr><th>.table</th><td>テーブル一覧を取得する</td></tr><tr><th>pragma_table_info(TABLE)</th><td>テーブルのカラム情報を取得する</td></tr></table>
<ul><li>.table</li></ul>
<pre class="">sqlite&gt; .table
attachments                          news
auth_sources                         open_id_authentication_associations
boards                               open_id_authentication_nonces
changes                              projects
changesets                           projects_trackers
changesets_issues                    queries
comments                             repositories
custom_fields                        roles
custom_fields_projects               schema_migrations
custom_fields_trackers               settings
custom_values                        time_entries
documents                            tokens
enabled_modules                      trackers
enumerations                         user_preferences
groups_users                         users
issue_categories                     versions
issue_relations                      watchers
issue_statuses                       wiki_content_versions
issues                               wiki_contents
journal_details                      wiki_pages
journals                             wiki_redirects
member_roles                         wikis
members                              workflows</pre>
<ul><li>pragma_table_info(TABLE)</li></ul>
<pre class="">sqlite&gt; pragma table_info(issues);
0|id|INTEGER|1||1
1|tracker_id|integer|1|0|0
2|project_id|integer|1|0|0
3|subject|varchar(255)|1|''|0
4|description|text|0||0
5|due_date|date|0||0
6|category_id|integer|0||0
7|status_id|integer|1|0|0
8|assigned_to_id|integer|0||0
9|priority_id|integer|1|0|0
10|fixed_version_id|integer|0||0
11|author_id|integer|1|0|0
12|lock_version|integer|1|0|0
13|created_on|datetime|0||0
14|updated_on|datetime|0||0
15|start_date|date|0||0
16|done_ratio|integer|1|0|0
17|estimated_hours|float|0||0
18|parent_id|integer|0|NULL|0
19|root_id|integer|0|NULL|0
20|lft|integer|0|NULL|0
21|rgt|integer|0|NULL|0</pre>
<p>今回欲しいテーブルはissues, journals, journal_detailsの3つでOKのはずなので<span class="footnote"><a href="#f3" title="チケットの履歴がjournalテーブルで管理されているのを探すのに手間取ったんだけど、どう探すのがクールなんだろう。チケット画面遷移したときのログで探して辿り着いたんだけど。" name="fn3">*3</a></span>これをちょっとメモしておく。</p>
<pre class="">sqlite&gt; pragma table_info(issues);
 0|id              |INTEGER     |1|    |1
 1|tracker_id      |integer     |1|0   |0
 2|project_id      |integer     |1|0   |0
 3|subject         |varchar(255)|1|''  |0
 4|description     |text        |0|    |0
 5|due_date        |date        |0|    |0
 6|category_id     |integer     |0|    |0
 7|status_id       |integer     |1|0   |0
 8|assigned_to_id  |integer     |0|    |0
 9|priority_id     |integer     |1|0   |0
10|fixed_version_id|integer     |0|    |0
11|author_id       |integer     |1|0   |0
12|lock_version    |integer     |1|0   |0
13|created_on      |datetime    |0|    |0
14|updated_on      |datetime    |0|    |0
15|start_date      |date        |0|    |0
16|done_ratio      |integer     |1|0   |0
17|estimated_hours |float       |0|    |0
18|parent_id       |integer     |0|NULL|0
19|root_id         |integer     |0|NULL|0
20|lft             |integer     |0|NULL|0
21|rgt             |integer     |0|NULL|0

sqlite&gt; pragma table_info(journals);
 0|id              |INTEGER     |1|    |1
 1|journalized_id  |integer     |1|0   |0
 2|journalized_type|varchar(30) |1|''  |0
 3|user_id         |integer     |1|0   |0
 4|notes           |text        |0|    |0
 5|created_on      |datetime    |1|    |0

sqlite&gt; pragma table_info(journal_details);
 0|id              |INTEGER     |1|    |1
 1|journal_id      |integer     |1|0   |0
 2|property        |varchar(30) |1|''  |0
 3|prop_key        |varchar(30) |1|''  |0
 4|old_value       |varchar(255)|0|    |0
 5|value           |varchar(255)|0|    |0</pre>
<p>これで準備とデータを見ることはできるようになった！　次からは実際にプラグインの中身に入っていく！ </p>
<div class="footnote"><p class="footnote"><a href="#fn1" name="f1">*1</a>: [http://redmine.jp/guide/RedmineInstall/:title=Redmineのインストール | Redmine.JP]　に準拠。</p><p class="footnote"><a href="#fn2" name="f2">*2</a>: 途中でコマンドプロンプトからConsole2というフリーソフトに切り替えたのでパスの区切りが\だったり/だったりしてます。</p><p class="footnote"><a href="#fn3" name="f3">*3</a>: チケットの履歴がjournalテーブルで管理されているのを探すのに手間取ったんだけど、どう探すのがクールなんだろう。チケット画面遷移したときのログで探して辿り着いたんだけど。</p></div>

<div class="pagination">
  <ul>
    
      <li class="prev">
        <a href="/2011/09/04/1315146050" title="vmstatとかiostatとかsarとかswapコマンドのメモ">
          vmstatとかiostatとかsarとかswapコマンドのメモ
        </a>
      </li>
    
    <li>
      <a href="/archives.html">Archive</a>
    </li>
    
      <li class="next">
        <a href="/2011/09/12/1315826713" title="Solarisのパッケージを作ってみる">
          Solarisのパッケージを作ってみる
        </a>
      </li>
    
  </ul>
</div>


<div class="social-module">
    <br>
  <!-- Tweet Button -->
  <a href="https://twitter.com/share"
     data-url="http://gosyujin.github.io/2011/09/07/1315401886" data-text="kk_Atakaの日記 - Redmineのプラグイン作成のための備忘録と、時々SQLite3" data-related="kk_Ataka"
     data-lang="ja" data-size="horizontal" data-dnt="true" class="twitter-share-button">Tweet</a>
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8" async="async"></script>

  <!-- Hatena Bookmark Users -->
  <a href="http://b.hatena.ne.jp/entry/http://gosyujin.github.io/2011/09/07/1315401886/">
    <img src="http://b.hatena.ne.jp/entry/image/http://gosyujin.github.io/2011/09/07/1315401886/" />
    </a>
  <!-- Hatena Bookmark Button -->
  <a href="http://b.hatena.ne.jp/entry/http://gosyujin.github.io/2011/09/07/1315401886/"
     data-hatena-bookmark-title="kk_Atakaの日記 - Redmineのプラグイン作成のための備忘録と、時々SQLite3"
     data-hatena-bookmark-layout="standard" class="hatena-bookmark-button" title="add Hatena bookmark">
    <img src="http://b.st-hatena.com/images/entry-button/button-only.gif"
	 alt="add Hatena bookmark" width="20" height="20" style="border: none;" />
    </a>
  <script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

  <!-- Hatena Bookmark comment http://blog.masuidrive.jp/2008/04/17/released-hatena-bookmark-anywhere/ -->
  <script type= "text/javascript">/*<![CDATA[*/
// var hatena_bookmark_anywhere_limit = 10; // 表示する件数
// var hatena_bookmark_anywhere_style = true; // trueでデフォルトスタイル falseを設定するとCSSでスタイルの指定が可能
// var hatena_bookmark_anywhere_collapse = false; // trueにすると、コメントの書いてないブクマを表示しない。指定しない場合は、表示件数を超えた場合のみコメントを表示しない
// var hatena_bookmark_anywhere_url = http://gosyujin.github.io/2011/09/07/1315401886/; // 表示するURL 未指定の場合、現在のページ
/*]]>*/</script>
  <script src="https://raw.github.com/masuidrive/hatena-bookmark-anywhere/master/hatena-bookmark-anywhere-0-1.js" type="text/javascript" charset="utf-8"></script>
  <div id="hatena_bookmark_anywhere"></div>
</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'kkataka'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


    </article>
    <hr />
    <address>Author: kk_Ataka / Powered by Jekyll on GitHub Pages</address>
  <body>
</html>

